# v6.0.0 Migration Guide

**Breaking Changes**: Production code moved from `scripts/` to `src/` structure

## Overview

v6.0.0 introduces a major restructuring to support robust convention-based packaging. **All production code** has moved from `scripts/` to `src/runtime/`.

## Who Needs to Migrate?

- ✅ **Users upgrading from npm**: Auto-migration handled by `postinstall`
- ✅ **Docker users**: New images use `/app/src/` paths automatically
- ⚠️ **Custom scripts/integrations**: May need path updates
- ⚠️ **CI/CD pipelines**: May need path updates

## Breaking Changes

### 1. File Paths Changed

| Old Path (v5.0.x) | New Path (v6.0.0+) |
|-------------------|-------------------|
| `scripts/import-conversations-unified.py` | `src/runtime/import-conversations-unified.py` |
| `scripts/unified_state_manager.py` | `src/runtime/unified_state_manager.py` |
| `scripts/metadata_extractor.py` | `src/runtime/metadata_extractor.py` |
| `scripts/message_processors.py` | `src/runtime/message_processors.py` |
| `scripts/import_strategies.py` | `src/runtime/import_strategies.py` |
| `scripts/embedding_service.py` | `src/runtime/embedding_service.py` |
| `scripts/doctor.py` | `src/runtime/doctor.py` |
| `scripts/delta-metadata-update.py` | `src/runtime/delta-metadata-update.py` |
| `scripts/delta-metadata-update-safe.py` | `src/runtime/delta-metadata-update-safe.py` |
| `scripts/force-metadata-recovery.py` | `src/runtime/force-metadata-recovery.py` |
| `scripts/streaming-importer.py` | `src/runtime/streaming-importer.py` |
| `scripts/streaming-watcher.py` | `src/runtime/streaming-watcher.py` |
| `scripts/import-latest.py` | `src/runtime/import-latest.py` |
| `scripts/precompact-hook.sh` | `src/runtime/precompact-hook.sh` |
| `scripts/watcher-loop.sh` | `src/runtime/watcher-loop.sh` |
| `scripts/utils.py` | `src/runtime/utils.py` |
| `scripts/importer/**/*.py` | `src/importer/**/*.py` |

### 2. Docker Paths Changed

**Volume mounts**:
```yaml
# OLD (v5.0.x)
volumes:
  - ./scripts:/scripts:ro

# NEW (v6.0.0+)
volumes:
  - ./src:/app/src:ro
  - ./shared:/app/shared:ro
```

**Commands**:
```yaml
# OLD
command: python /scripts/import-conversations-unified.py

# NEW
command: python /app/src/runtime/import-conversations-unified.py
```

**Environment**:
```yaml
# NEW (required)
environment:
  - PYTHONPATH=/app
```

### 3. Import Statements

**No changes needed** for imports within production code - they use relative imports.

## Migration Steps

### For npm Users

```bash
# 1. Upgrade to v6.0.0
npm install -g claude-self-reflect@6.0.0

# 2. Auto-migration runs via postinstall
# Output: "Migrating to v6.0.0 structure..."

# 3. Verify installation
claude-self-reflect --version
# Should show: 6.0.0
```

**That's it!** The installer handles the migration automatically.

### For Docker Users

```bash
# 1. Pull new docker-compose.yaml
cd /path/to/claude-self-reflect
git pull origin main

# 2. Rebuild containers
docker compose down
docker compose build

# 3. Start services
docker compose up -d qdrant
docker compose --profile import up importer
```

### For Custom Integrations

If you have **custom scripts** or **CI/CD pipelines** that reference old paths:

```bash
# Find all references to old paths
grep -r "scripts/import-conversations-unified" .
grep -r "scripts/metadata_extractor" .
grep -r "scripts/unified_state_manager" .

# Update each reference:
# OLD: python scripts/import-conversations-unified.py
# NEW: python src/runtime/import-conversations-unified.py
```

### For Development Environments

```bash
# 1. Navigate to repo
cd /path/to/claude-self-reflect

# 2. Checkout v6.0.0
git fetch origin
git checkout v6.0.0

# 3. Update Python path if running scripts directly
export PYTHONPATH=/path/to/claude-self-reflect

# 4. Run scripts with new paths
python src/runtime/import-conversations-unified.py
```

## Verification

### Verify npm Package

```bash
# Check installed version
npm list -g claude-self-reflect
# Should show: claude-self-reflect@6.0.0

# Check files exist
ls $(npm root -g)/claude-self-reflect/src/runtime/
# Should list: import-conversations-unified.py, etc.
```

### Verify Docker

```bash
# Check container uses new paths
docker compose config | grep "command:"
# Should show: /app/src/runtime/...

# Test import
docker compose --profile import up importer
# Should complete successfully
```

### Verify Local Install

```bash
# Run import test
cd /path/to/claude-self-reflect
python src/runtime/import-conversations-unified.py --help
# Should show help message

# Check MCP server
./mcp-server/run-mcp.sh
# Should start without errors
```

## Rollback

If you need to rollback to v5.0.7:

```bash
# npm users
npm install -g claude-self-reflect@5.0.7

# Docker users
git checkout v5.0.7
docker compose build
```

## Common Issues

### "ModuleNotFoundError: No module named 'scripts'"

**Cause**: Old path reference in custom script or integration

**Fix**: Update path from `scripts/` to `src/runtime/`

### "File not found: /scripts/import-conversations-unified.py"

**Cause**: Docker using old paths

**Fix**:
```bash
# Pull new docker-compose.yaml
git pull origin main

# Rebuild
docker compose build
```

### "ImportError: cannot import name 'X' from 'src.runtime.utils'"

**Cause**: Incorrect Python path

**Fix**:
```bash
export PYTHONPATH=/path/to/claude-self-reflect
```

Or in Docker, ensure:
```yaml
environment:
  - PYTHONPATH=/app
```

## FAQ

### Do I need to re-import my conversations?

**No**. Existing Qdrant data is unchanged. Only file locations changed.

### Will old backups still work?

**Yes**. Qdrant backups are version-independent.

### Can I run v5.0.x and v6.0.0 side-by-side?

**No**. They share the same Qdrant database. Use different `QDRANT_PORT` if needed.

### Are dev scripts gone?

**No**. They moved to `scripts/{dev,migration,quality,maintenance}/` but are **excluded from npm package**. Clone the repo to access them.

## Benefits of v6.0.0

✅ **Robust packaging**: Wildcards work safely (production in `src/`, dev in `scripts/`)
✅ **Smaller packages**: 28% smaller (224 KB vs 287 KB)
✅ **No forgotten files**: Wildcards prevent issues like PR #80
✅ **Industry standard**: Matches React/Vue/TypeScript patterns
✅ **Clear separation**: Production vs development code

## Support

- **Issues**: https://github.com/ramakay/claude-self-reflect/issues
- **Discussions**: https://github.com/ramakay/claude-self-reflect/discussions
- **Packaging Workflow**: See `docs/development/packaging-workflow.md`

---

**Related**:
- Issue #97: src/ restructuring
- Issue #84: Dynamic package testing
- Issue #98: scripts/ organization
- PR #XXX: Convention-based packaging v6.0.0
