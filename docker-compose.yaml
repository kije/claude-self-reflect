volumes:
  qdrant_data:

services:
  # Fix permissions for config directory (UID 1001 matches appuser in Dockerfiles)
  init-permissions:
    image: alpine
    command: sh -c "chown -R 1001:1001 /config && chown -R 1001:1001 /batch_queue && chown -R 1001:1001 /batch_state"
    volumes:
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
      - ${CSR_BATCH_QUEUE_DIR:-${HOME}/.claude-self-reflect/batch_queue}:/batch_queue
      - ${CSR_BATCH_STATE_DIR:-${HOME}/.claude-self-reflect/batch_state}:/batch_state
    profiles: ["watch", "import", "async", "safe-watch", "batch-automation"]

  # Qdrant vector database - the heart of semantic search
  qdrant:
    image: qdrant/qdrant:v1.15.1
    container_name: claude-reflection-qdrant
    ports:
      - "${QDRANT_PORT:-6333}:6333"
    volumes:
      - qdrant_data:/qdrant/storage
      # Note: Using CONFIG_PATH variable to support global npm installs (fixes #71)
      # macOS Docker Desktop restricts mounts to /Users, /Volumes, /private, /tmp
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}/qdrant-config.yaml:/qdrant/config/config.yaml:ro
    environment:
      - QDRANT__LOG_LEVEL=INFO
      - QDRANT__SERVICE__HTTP_PORT=6333
    restart: unless-stopped
    mem_limit: ${QDRANT_MEMORY:-4g}
    memswap_limit: ${QDRANT_MEMORY:-4g}

  # One-time import service (runs once then exits)
  importer:
    build:
      context: .
      dockerfile: Dockerfile.importer
    container_name: claude-reflection-importer
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - LOGS_DIR=/logs
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-voyage-3}
      - BATCH_SIZE=${BATCH_SIZE:-50}
      - CHUNK_SIZE=${CHUNK_SIZE:-10}
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    restart: "no"
    profiles: ["import"]
    command: python /app/src/runtime/import-conversations-unified.py

  # Continuous watcher service (optional) - DEPRECATED, use streaming-importer
  watcher:
    build:
      context: .
      dockerfile: Dockerfile.watcher
    container_name: claude-reflection-watcher
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
      - /tmp:/tmp
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-voyage-3}
      - WATCH_INTERVAL=${WATCH_INTERVAL:-5}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-250}
      - CHUNK_SIZE=${CHUNK_SIZE:-5}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    profiles: ["watch-old"]
    mem_limit: 500m
    memswap_limit: 500m

  # Streaming importer service - Low memory continuous import
  streaming-importer:
    build:
      context: .
      dockerfile: Dockerfile.streaming-importer
    container_name: claude-reflection-streaming
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/streaming-state.json  # FIXED: Use streaming-specific state file
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      # Production CPU throttling settings
      - MAX_CPU_PERCENT_PER_CORE=25  # 25% per core = 400% total on 16 cores
      - MAX_CONCURRENT_EMBEDDINGS=1  # Limit concurrent embeddings
      - MAX_CONCURRENT_QDRANT=2  # Limit concurrent Qdrant operations
      - IMPORT_FREQUENCY=5  # Check every 5 seconds for faster processing
      - BATCH_SIZE=20  # Process 20 files at a time (increased from 3)
      - MEMORY_LIMIT_MB=1500  # Memory limit (increased to 1.5GB)
      - MAX_QUEUE_SIZE=500  # Increased queue size to handle backlog
      - MAX_BACKLOG_HOURS=24  # Alert if backlog > 24 hours
      - QDRANT_TIMEOUT=10  # 10 second timeout for Qdrant ops
      - MAX_RETRIES=3  # Retry failed operations
      - RETRY_DELAY=1  # Initial retry delay
      - PYTHONUNBUFFERED=1
      - LOGS_DIR=/logs
      - FASTEMBED_CACHE_PATH=/root/.cache/fastembed
      - MALLOC_ARENA_MAX=2  # MEMORY LEAK FIX: Limit glibc malloc arenas
    restart: "no"  # DISABLED - causes system overload
    profiles: ["watch-disabled"]  # Changed from "watch" to disable auto-start
    mem_limit: 2g  # Increased from 500m to 2GB
    memswap_limit: 2g
    cpus: 8.0  # Increased CPU limit to 8 cores for faster processing

  # Async streaming importer - Ground-up async rewrite
  async-importer:
    build:
      context: .
      dockerfile: Dockerfile.async-importer
    container_name: claude-reflection-async
    depends_on:
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/imported-files.json
      - VOYAGE_API_KEY=${VOYAGE_API_KEY:-}
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - WATCH_INTERVAL=${WATCH_INTERVAL:-5}
      - MAX_MEMORY_MB=${MAX_MEMORY_MB:-2000}
      - OPERATIONAL_MEMORY_MB=${OPERATIONAL_MEMORY_MB:-1500}
      - CHUNK_SIZE=${CHUNK_SIZE:-5}
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-15}
      - MAX_COLD_FILES_PER_CYCLE=${MAX_COLD_FILES_PER_CYCLE:-5}
      - THREAD_POOL_WORKERS=${THREAD_POOL_WORKERS:-2}
      - PYTHONUNBUFFERED=1
      - LOGS_DIR=/logs
      - FASTEMBED_CACHE_PATH=/root/.cache/fastembed
      - CURRENT_PROJECT_PATH=${PWD}
      - MALLOC_ARENA_MAX=2
    restart: unless-stopped
    profiles: ["async"]
    mem_limit: 4g
    memswap_limit: 4g

  # Safe watcher with hot/warm/cold priority
  safe-watcher:
    build:
      context: .
      dockerfile: Dockerfile.safe-watcher
    container_name: claude-reflection-safe-watcher
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/config
    environment:
      - QDRANT_URL=http://qdrant:6333
      - STATE_FILE=/config/csr-watcher.json
      - LOGS_DIR=/logs  # Fixed: Point to mounted volume
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - ENABLE_MEMORY_DECAY=${ENABLE_MEMORY_DECAY:-false}
      - DECAY_WEIGHT=${DECAY_WEIGHT:-0.3}
      - DECAY_SCALE_DAYS=${DECAY_SCALE_DAYS:-90}
      - CHECK_INTERVAL_S=${CHECK_INTERVAL_S:-60}
      - HOT_CHECK_INTERVAL_S=${HOT_CHECK_INTERVAL_S:-2}
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-5}
      - WARM_WINDOW_HOURS=${WARM_WINDOW_HOURS:-24}
      - MAX_COLD_FILES=${MAX_COLD_FILES:-5}
      - MAX_WARM_WAIT_MINUTES=${MAX_WARM_WAIT_MINUTES:-30}
      - MAX_MESSAGES_PER_CHUNK=${MAX_MESSAGES_PER_CHUNK:-10}
      - MAX_CHUNK_SIZE=${MAX_CHUNK_SIZE:-50}  # Messages per chunk for streaming
      - MEMORY_LIMIT_MB=${MEMORY_LIMIT_MB:-1000}
      - MEMORY_WARNING_MB=${MEMORY_WARNING_MB:-500}
      - PYTHONUNBUFFERED=1
      - MALLOC_ARENA_MAX=2
    restart: unless-stopped
    profiles: ["safe-watch", "watch"]  # Requires explicit profile to run
    mem_limit: 1g  # Increased to 1GB to match MEMORY_LIMIT_MB
    memswap_limit: 1g
    cpus: 1.0  # Single CPU core limit

  # MCP server for Claude integration
  mcp-server:
    build:
      context: .
      dockerfile: Dockerfile.mcp-server
    container_name: claude-reflection-mcp
    depends_on:
      - qdrant
    environment:
      - QDRANT_URL=http://qdrant:6333
      - VOYAGE_KEY=${VOYAGE_KEY:-}
      - PREFER_LOCAL_EMBEDDINGS=${PREFER_LOCAL_EMBEDDINGS:-true}
      - ENABLE_MEMORY_DECAY=${ENABLE_MEMORY_DECAY:-true}
      - DECAY_WEIGHT=${DECAY_WEIGHT:-0.3}
      - DECAY_SCALE_DAYS=${DECAY_SCALE_DAYS:-90}
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    stdin_open: true
    tty: true
    profiles: ["mcp"]

  # Batch watcher - Queues conversations and triggers batch narrative generation
  # OPTIONAL: Requires ANTHROPIC_API_KEY. Disabled by default.
  # Enable via CLI during installation or: docker compose --profile batch-automation up -d
  batch-watcher:
    build:
      context: .
      dockerfile: Dockerfile.batch-watcher
    container_name: claude-reflection-batch-watcher
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CLAUDE_LOGS_PATH:-${HOME}/.claude/projects}:/logs:ro
      - ${CONFIG_PATH:-${HOME}/.claude-self-reflect/config}:/home/appuser/.claude-self-reflect/config
      - ${CSR_BATCH_QUEUE_DIR:-${HOME}/.claude-self-reflect/batch_queue}:/home/appuser/.claude-self-reflect/batch_queue
      - ${CSR_BATCH_STATE_DIR:-${HOME}/.claude-self-reflect/batch_state}:/home/appuser/.claude-self-reflect/batch_state
    environment:
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CSR_HOME=/home/appuser/.claude-self-reflect
      - CSR_CONFIG_DIR=/home/appuser/.claude-self-reflect/config
      - CSR_BATCH_QUEUE_DIR=/home/appuser/.claude-self-reflect/batch_queue
      - CSR_BATCH_STATE_DIR=/home/appuser/.claude-self-reflect/batch_state
      - CLAUDE_PROJECTS_DIR=/logs
      - BATCH_SIZE_TRIGGER=${BATCH_SIZE_TRIGGER:-10}
      - BATCH_TIME_TRIGGER_MINUTES=${BATCH_TIME_TRIGGER_MINUTES:-30}
      - HOT_WINDOW_MINUTES=${HOT_WINDOW_MINUTES:-5}
      - WARM_WINDOW_HOURS=${WARM_WINDOW_HOURS:-24}
      - MAX_COLD_FILES=${MAX_COLD_FILES:-5}
      - SUBPROCESS_TIMEOUT_SECONDS=${SUBPROCESS_TIMEOUT_SECONDS:-1800}
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    restart: unless-stopped
    profiles: ["batch-automation"]
    mem_limit: 2g
    memswap_limit: 2g
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[p]ython.*batch_watcher' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=batch-watcher"

  # Batch monitor - Monitors batch API jobs and triggers evaluations
  # OPTIONAL: Requires ANTHROPIC_API_KEY. Disabled by default.
  batch-monitor:
    build:
      context: .
      dockerfile: Dockerfile.batch-monitor
    container_name: claude-reflection-batch-monitor
    depends_on:
      - init-permissions
      - qdrant
    volumes:
      - ${CSR_BATCH_STATE_DIR:-${HOME}/.claude-self-reflect/batch_state}:/home/appuser/.claude-self-reflect/batch_state
    environment:
      - QDRANT_URL=http://qdrant:6333
      - QDRANT_API_KEY=${QDRANT_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CSR_HOME=/home/appuser/.claude-self-reflect
      - CSR_BATCH_STATE_DIR=/home/appuser/.claude-self-reflect/batch_state
      - CHECK_INTERVAL=${BATCH_MONITOR_INTERVAL:-60}
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    restart: unless-stopped
    profiles: ["batch-automation"]
    mem_limit: 512m
    memswap_limit: 512m
    healthcheck:
      test: ["CMD-SHELL", "ps aux | grep -q '[p]ython.*batch_monitor' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        labels: "service=batch-monitor"

networks:
  default:
    name: claude-reflection-network
    external: false
