FROM python:3.13-slim

# SECURITY: CVE-2025-58050 mitigation - PCRE2 heap buffer overflow
# SECURITY: CVE-2025-7709 mitigation - SQLite3 vulnerability
# Update system packages for security and install build dependencies for psutil
# TODO: Remove explicit upgrades when base image includes patched versions
RUN apt-get update && \
    (apt-get install -y --only-upgrade libpcre2-8-0 2>/dev/null || \
     echo "Warning: PCRE2 10.46+ not yet available") && \
    (apt-get install -y --only-upgrade libsqlite3-0 sqlite3 2>/dev/null || \
     echo "Warning: SQLite3 patch not yet available") && \
    apt-get upgrade -y && \
    apt-get install -y gcc python3-dev && \
    rm -rf /var/lib/apt/lists/*

# Install Python dependencies
RUN pip install --no-cache-dir \
    psutil==5.9.5 \
    qdrant-client>=1.7.0 \
    openai>=1.0.0 \
    backoff>=2.2.0 \
    requests>=2.31.0 \
    tqdm>=4.66.0 \
    voyageai>=0.2.0 \
    fastembed>=0.4.0

# Create non-root user
RUN useradd -m -u 1000 watcher

# Pre-download FastEmbed model to avoid runtime downloads
RUN mkdir -p /home/watcher/.cache && \
    FASTEMBED_CACHE_PATH=/home/watcher/.cache/fastembed python -c "from fastembed import TextEmbedding; import os; os.environ['FASTEMBED_CACHE_PATH']='/home/watcher/.cache/fastembed'; TextEmbedding('sentence-transformers/all-MiniLM-L6-v2')" && \
    chown -R watcher:watcher /home/watcher/.cache

# Copy source code
WORKDIR /app
COPY src/ /app/src/
COPY shared/ /app/shared/

# Set PYTHONPATH for proper imports
ENV PYTHONPATH=/app

RUN chmod +x /app/src/runtime/*.sh /app/src/runtime/*.py

# Switch to non-root user
USER watcher

# Default command - use streaming importer for low memory usage
CMD ["python", "/app/src/runtime/streaming-importer.py"]